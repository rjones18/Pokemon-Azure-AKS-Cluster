trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  jobs:
  - job: BuildZarfPackage
    displayName: Build Zarf Package
    steps:
    - checkout: self

    - script: |
        echo "Installing Brew and Zarf CLI..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.profile
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bash_profile
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zshrc
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        source ~/.profile  # Or the appropriate file for your shell
        brew tap defenseunicorns/tap && brew install zarf
        echo "Building Zarf package..."
        zarf package create --output=zarf-httpd-package.tar.gz | y

      displayName: 'Install Zarf CLI and Create Zarf Package'
    
    # Upload Zarf Package to Azure Blob Storage
    - script: |
        echo "Uploading Zarf package to Azure Blob Storage..."
        az storage blob upload --account-name rjzarfstorage --container-name zarf --file zarf-httpd-package.tar.gz --name zarf-httpd-package.tar.gz
      displayName: 'Upload Zarf Package'